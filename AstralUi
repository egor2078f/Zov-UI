--[[
    ASTRAL GLASS LIBRARY 2025
    Design: iOS Glassmorphism
    Features: HSV Color Picker, Smooth Tweens, Modern UI
]]

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")

local Astral = {}

--// Настройки стиля (Glassmorphism)
local Theme = {
	MainFrame = Color3.fromRGB(20, 20, 20), -- Темная основа
	MainTransparency = 0.2, -- Прозрачность для стекла
	
	Header = Color3.fromRGB(30, 30, 30),
	HeaderTransparency = 0.5,
	
	Sidebar = Color3.fromRGB(25, 25, 25),
	SidebarTransparency = 0.4,
	
	Element = Color3.fromRGB(40, 40, 40),
	ElementTransparency = 0.4,
	
	Text = Color3.fromRGB(255, 255, 255),
	SubText = Color3.fromRGB(180, 180, 180),
	
	Accent = Color3.fromRGB(0, 122, 255), -- iOS Blue
	Stroke = Color3.fromRGB(255, 255, 255), -- Белая обводка
	StrokeTransparency = 0.85 -- Еле заметная обводка
}

--// Утилиты
local function Create(class, props)
	local inst = Instance.new(class)
	for i, v in pairs(props) do
		inst[i] = v
	end
	return inst
end

local function Round(instance, radius)
	Create("UICorner", {CornerRadius = UDim.new(0, radius), Parent = instance})
end

local function Stroke(instance, thickness, transparency)
	Create("UIStroke", {
		Color = Theme.Stroke,
		Thickness = thickness or 1,
		Transparency = transparency or Theme.StrokeTransparency,
		ApplyStrokeMode = Enum.ApplyStrokeMode.Border,
		Parent = instance
	})
end

local function AddBlur(parent)
	-- Роблокс не позволяет делать настоящий UI Blur на ScreenGui без костылей с Lighting,
	-- поэтому мы эмулируем его через прозрачность и шум, но для чистоты кода оставим просто качественную прозрачность.
end

-- Плавное перетаскивание
local function MakeDraggable(topbar, object)
	local dragging, dragInput, dragStart, startPos
	
	topbar.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			dragging = true
			dragStart = input.Position
			startPos = object.Position
			
			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then dragging = false end
			end)
		end
	end)
	
	topbar.InputChanged:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
			dragInput = input
		end
	end)
	
	UserInputService.InputChanged:Connect(function(input)
		if input == dragInput and dragging then
			local delta = input.Position - dragStart
			local targetPos = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
			TweenService:Create(object, TweenInfo.new(0.08, Enum.EasingStyle.Sine), {Position = targetPos}):Play()
		end
	end)
end

--// Главная функция
function Astral.New(settings)
	local Title = settings.Title or "Astral Glass"
	
	-- Очистка старого UI
	local Parent = Players.LocalPlayer:WaitForChild("PlayerGui")
	if Parent:FindFirstChild("AstralGlassUI") then Parent["AstralGlassUI"]:Destroy() end
	
	local ScreenGui = Create("ScreenGui", {Name = "AstralGlassUI", Parent = Parent, ResetOnSpawn = false, ZIndexBehavior = Enum.ZIndexBehavior.Sibling})
	
	-- 1. Main Container (Glass Effect)
	local MainFrame = Create("Frame", {
		Name = "MainFrame",
		Parent = ScreenGui,
		BackgroundColor3 = Theme.MainFrame,
		BackgroundTransparency = Theme.MainTransparency,
		Position = UDim2.new(0.5, -275, 0.5, -175),
		Size = UDim2.new(0, 550, 0, 380),
		BorderSizePixel = 0,
		ClipsDescendants = true
	})
	Round(MainFrame, 16) -- Большой радиус как на iOS
	Stroke(MainFrame, 1.5, 0.8) -- Тонкая рамка
	
	-- Тень для объема
	local Shadow = Create("ImageLabel", {
		Parent = MainFrame,
		BackgroundTransparency = 1,
		Image = "rbxassetid://5554236805",
		ScaleType = Enum.ScaleType.Slice,
		SliceCenter = Rect.new(23,23,277,277),
		Size = UDim2.new(1, 50, 1, 50),
		Position = UDim2.new(0, -25, 0, -25),
		ImageColor3 = Color3.fromRGB(0,0,0),
		ImageTransparency = 0.4,
		ZIndex = -1
	})
	
	-- 2. Sidebar (Left)
	local Sidebar = Create("Frame", {
		Parent = MainFrame,
		BackgroundColor3 = Theme.Sidebar,
		BackgroundTransparency = Theme.SidebarTransparency,
		Size = UDim2.new(0, 140, 1, 0),
		BorderSizePixel = 0
	})
	-- Разделительная линия
	local SidebarLine = Create("Frame", {
		Parent = Sidebar,
		BackgroundColor3 = Theme.Stroke,
		BackgroundTransparency = 0.8,
		Size = UDim2.new(0, 1, 1, 0),
		Position = UDim2.new(1, -1, 0, 0),
		BorderSizePixel = 0
	})
	
	-- Заголовок в сайдбаре
	local TitleLabel = Create("TextLabel", {
		Parent = Sidebar,
		BackgroundTransparency = 1,
		Size = UDim2.new(1, -20, 0, 50),
		Position = UDim2.new(0, 15, 0, 10),
		Text = Title,
		Font = Enum.Font.GothamBold,
		TextColor3 = Theme.Text,
		TextSize = 20,
		TextXAlignment = Enum.TextXAlignment.Left
	})
	
	local TabContainer = Create("ScrollingFrame", {
		Parent = Sidebar,
		BackgroundTransparency = 1,
		Size = UDim2.new(1, 0, 1, -70),
		Position = UDim2.new(0, 0, 0, 70),
		ScrollBarThickness = 0,
		CanvasSize = UDim2.new(0,0,0,0)
	})
	Create("UIListLayout", {Parent = TabContainer, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 5)})
	Create("UIPadding", {Parent = TabContainer, PaddingLeft = UDim.new(0, 10), PaddingRight = UDim.new(0, 10)})
	
	-- 3. Content Area (Right)
	local ContentArea = Create("Frame", {
		Parent = MainFrame,
		BackgroundTransparency = 1,
		Size = UDim2.new(1, -140, 1, 0),
		Position = UDim2.new(0, 140, 0, 0)
	})
	
	-- Драг за любую пустую область контента или сайдбара
	MakeDraggable(MainFrame, MainFrame)
	
	local LibraryLogic = {}
	local FirstTab = true
	
	function LibraryLogic:Tab(name, icon)
		-- Tab Button
		local TabBtn = Create("TextButton", {
			Parent = TabContainer,
			BackgroundColor3 = Color3.fromRGB(255,255,255),
			BackgroundTransparency = 1,
			Size = UDim2.new(1, 0, 0, 32),
			Text = name,
			Font = Enum.Font.GothamMedium,
			TextColor3 = Theme.SubText,
			TextSize = 14,
			TextXAlignment = Enum.TextXAlignment.Left,
			AutoButtonColor = false
		})
		Round(TabBtn, 8)
		Create("UIPadding", {Parent = TabBtn, PaddingLeft = UDim.new(0, 10)})
		
		-- Page
		local Page = Create("ScrollingFrame", {
			Parent = ContentArea,
			BackgroundTransparency = 1,
			Size = UDim2.new(1, 0, 1, 0),
			Visible = false,
			ScrollBarThickness = 3,
			ScrollBarImageColor3 = Theme.Accent,
			CanvasSize = UDim2.new(0,0,0,0)
		})
		local PageLayout = Create("UIListLayout", {Parent = Page, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 10)})
		Create("UIPadding", {Parent = Page, PaddingTop = UDim.new(0, 20), PaddingLeft = UDim.new(0, 20), PaddingRight = UDim.new(0, 20), PaddingBottom = UDim.new(0,20)})
		
		PageLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
			Page.CanvasSize = UDim2.new(0, 0, 0, PageLayout.AbsoluteContentSize.Y + 40)
		end)
		
		-- Activation Logic
		local function Activate()
			for _, v in pairs(TabContainer:GetChildren()) do
				if v:IsA("TextButton") then
					TweenService:Create(v, TweenInfo.new(0.3), {BackgroundTransparency = 1, TextColor3 = Theme.SubText}):Play()
				end
			end
			for _, v in pairs(ContentArea:GetChildren()) do v.Visible = false end
			
			TweenService:Create(TabBtn, TweenInfo.new(0.3), {BackgroundTransparency = 0.9, TextColor3 = Theme.Text}):Play()
			Page.Visible = true
		end
		
		TabBtn.MouseButton1Click:Connect(Activate)
		
		if FirstTab then Activate() FirstTab = false end
		
		local Elements = {}
		
		-- LABEL
		function Elements:Label(text)
			local Label = Create("TextLabel", {
				Parent = Page,
				BackgroundTransparency = 1,
				Size = UDim2.new(1, 0, 0, 25),
				Text = text,
				Font = Enum.Font.GothamBold,
				TextColor3 = Theme.SubText,
				TextSize = 12,
				TextXAlignment = Enum.TextXAlignment.Left
			})
		end
		
		-- BUTTON
		function Elements:Button(text, callback)
			local Btn = Create("TextButton", {
				Parent = Page,
				BackgroundColor3 = Theme.Element,
				BackgroundTransparency = Theme.ElementTransparency,
				Size = UDim2.new(1, 0, 0, 40),
				Text = "",
				AutoButtonColor = false
			})
			Round(Btn, 10)
			
			local BtnLabel = Create("TextLabel", {
				Parent = Btn,
				BackgroundTransparency = 1,
				Size = UDim2.new(1, 0, 1, 0),
				Text = text,
				Font = Enum.Font.GothamSemibold,
				TextColor3 = Theme.Text,
				TextSize = 14
			})
			
			Btn.MouseButton1Click:Connect(function()
				local t = TweenService:Create(Btn, TweenInfo.new(0.1), {BackgroundColor3 = Theme.Accent, BackgroundTransparency = 0.2})
				t:Play()
				t.Completed:Connect(function()
					TweenService:Create(Btn, TweenInfo.new(0.3), {BackgroundColor3 = Theme.Element, BackgroundTransparency = Theme.ElementTransparency}):Play()
				end)
				callback()
			end)
		end
		
		-- TOGGLE (iOS Switch)
		function Elements:Toggle(text, default, callback)
			local toggled = default or false
			
			local ToggleFrame = Create("Frame", {
				Parent = Page,
				BackgroundColor3 = Theme.Element,
				BackgroundTransparency = Theme.ElementTransparency,
				Size = UDim2.new(1, 0, 0, 40)
			})
			Round(ToggleFrame, 10)
			
			local Label = Create("TextLabel", {
				Parent = ToggleFrame,
				BackgroundTransparency = 1,
				Size = UDim2.new(1, -60, 1, 0),
				Position = UDim2.new(0, 15, 0, 0),
				Text = text,
				Font = Enum.Font.Gotham,
				TextColor3 = Theme.Text,
				TextSize = 14,
				TextXAlignment = Enum.TextXAlignment.Left
			})
			
			local SwitchBtn = Create("TextButton", {
				Parent = ToggleFrame,
				BackgroundColor3 = toggled and Theme.Accent or Color3.fromRGB(60,60,60),
				Size = UDim2.new(0, 44, 0, 24),
				Position = UDim2.new(1, -55, 0.5, -12),
				Text = "",
				AutoButtonColor = false
			})
			Round(SwitchBtn, 12)
			
			local Circle = Create("Frame", {
				Parent = SwitchBtn,
				BackgroundColor3 = Color3.fromRGB(255,255,255),
				Size = UDim2.new(0, 20, 0, 20),
				Position = toggled and UDim2.new(1, -22, 0.5, -10) or UDim2.new(0, 2, 0.5, -10)
			})
			Round(Circle, 10)
			
			SwitchBtn.MouseButton1Click:Connect(function()
				toggled = not toggled
				
				TweenService:Create(SwitchBtn, TweenInfo.new(0.2), {BackgroundColor3 = toggled and Theme.Accent or Color3.fromRGB(60,60,60)}):Play()
				TweenService:Create(Circle, TweenInfo.new(0.2), {Position = toggled and UDim2.new(1, -22, 0.5, -10) or UDim2.new(0, 2, 0.5, -10)}):Play()
				
				callback(toggled)
			end)
		end
		
		-- SLIDER
		function Elements:Slider(text, min, max, default, callback)
			local val = default or min
			
			local SliderFrame = Create("Frame", {
				Parent = Page,
				BackgroundColor3 = Theme.Element,
				BackgroundTransparency = Theme.ElementTransparency,
				Size = UDim2.new(1, 0, 0, 55)
			})
			Round(SliderFrame, 10)
			
			local Label = Create("TextLabel", {
				Parent = SliderFrame,
				BackgroundTransparency = 1,
				Size = UDim2.new(1, 0, 0, 20),
				Position = UDim2.new(0, 15, 0, 8),
				Text = text,
				Font = Enum.Font.Gotham,
				TextColor3 = Theme.Text,
				TextSize = 14,
				TextXAlignment = Enum.TextXAlignment.Left
			})
			
			local ValLabel = Create("TextLabel", {
				Parent = SliderFrame,
				BackgroundTransparency = 1,
				Size = UDim2.new(0, 50, 0, 20),
				Position = UDim2.new(1, -60, 0, 8),
				Text = tostring(val),
				Font = Enum.Font.GothamBold,
				TextColor3 = Theme.SubText,
				TextSize = 14,
				TextXAlignment = Enum.TextXAlignment.Right
			})
			
			local Bar = Create("Frame", {
				Parent = SliderFrame,
				BackgroundColor3 = Color3.fromRGB(60,60,60),
				Size = UDim2.new(1, -30, 0, 4),
				Position = UDim2.new(0, 15, 0, 38)
			})
			Round(Bar, 2)
			
			local Fill = Create("Frame", {
				Parent = Bar,
				BackgroundColor3 = Theme.Accent,
				Size = UDim2.new((val - min) / (max - min), 0, 1, 0)
			})
			Round(Fill, 2)
			
			local Knob = Create("Frame", {
				Parent = Fill,
				BackgroundColor3 = Color3.fromRGB(255,255,255),
				Size = UDim2.new(0, 16, 0, 16),
				Position = UDim2.new(1, -8, 0.5, -8),
				AnchorPoint = Vector2.new(0,0)
			})
			Round(Knob, 8)
			
			local dragging = false
			local function Update(input)
				local percent = math.clamp((input.Position.X - Bar.AbsolutePosition.X) / Bar.AbsoluteSize.X, 0, 1)
				local newVal = math.floor(min + (max - min) * percent)
				
				TweenService:Create(Fill, TweenInfo.new(0.05), {Size = UDim2.new(percent, 0, 1, 0)}):Play()
				ValLabel.Text = tostring(newVal)
				callback(newVal)
			end
			
			SliderFrame.InputBegan:Connect(function(input)
				if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
					dragging = true
					Update(input)
				end
			end)
			UserInputService.InputChanged:Connect(function(input)
				if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
					Update(input)
				end
			end)
			UserInputService.InputEnded:Connect(function(input)
				if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then dragging = false end
			end)
		end
		
		-- REAL HSV COLOR PICKER
		function Elements:ColorPicker(text, default, callback)
			local ColorH, ColorS, ColorV = 1, 1, 1
			if default then ColorH, ColorS, ColorV = default:ToHSV() end
			
			local isOpen = false
			
			local PickerFrame = Create("Frame", {
				Parent = Page,
				BackgroundColor3 = Theme.Element,
				BackgroundTransparency = Theme.ElementTransparency,
				Size = UDim2.new(1, 0, 0, 40),
				ClipsDescendants = true
			})
			Round(PickerFrame, 10)
			
			local ToggleBtn = Create("TextButton", {
				Parent = PickerFrame,
				BackgroundTransparency = 1,
				Size = UDim2.new(1, 0, 0, 40),
				Text = "",
				AutoButtonColor = false
			})
			
			local Label = Create("TextLabel", {
				Parent = ToggleBtn,
				BackgroundTransparency = 1,
				Size = UDim2.new(1, 0, 0, 40),
				Position = UDim2.new(0, 15, 0, 0),
				Text = text,
				Font = Enum.Font.Gotham,
				TextColor3 = Theme.Text,
				TextSize = 14,
				TextXAlignment = Enum.TextXAlignment.Left
			})
			
			local Preview = Create("Frame", {
				Parent = ToggleBtn,
				BackgroundColor3 = default or Color3.fromRGB(255,255,255),
				Size = UDim2.new(0, 40, 0, 24),
				Position = UDim2.new(1, -55, 0.5, -12)
			})
			Round(Preview, 6)
			Stroke(Preview, 1, 0.5)
			
			-- Container for the Real Picker
			local CPContainer = Create("Frame", {
				Parent = PickerFrame,
				BackgroundTransparency = 1,
				Size = UDim2.new(1, -30, 0, 180),
				Position = UDim2.new(0, 15, 0, 50)
			})
			
			-- 1. SV Square (Saturation / Value)
			local SVImage = Create("ImageButton", {
				Parent = CPContainer,
				Size = UDim2.new(0, 150, 0, 150),
				Position = UDim2.new(0, 0, 0, 0),
				Image = "rbxassetid://4155801252", -- Градиент SV
				BackgroundColor3 = Color3.fromHSV(ColorH, 1, 1),
				AutoButtonColor = false
			})
			Round(SVImage, 6)
			
			local SVCursor = Create("Frame", {
				Parent = SVImage,
				BackgroundColor3 = Color3.new(1,1,1),
				Size = UDim2.new(0, 10, 0, 10),
				AnchorPoint = Vector2.new(0.5, 0.5),
				Position = UDim2.new(ColorS, 0, 1-ColorV, 0)
			})
			Round(SVCursor, 5)
			Stroke(SVCursor, 1, 0) -- Черная обводка для видимости
			
			-- 2. Hue Slider (Rainbow Strip)
			local HueFrame = Create("ImageButton", {
				Parent = CPContainer,
				Size = UDim2.new(0, 30, 0, 150),
				Position = UDim2.new(0, 165, 0, 0),
				BackgroundColor3 = Color3.new(1,1,1),
				AutoButtonColor = false
			})
			Round(HueFrame, 6)
			
			local HueGradient = Create("UIGradient", {
				Parent = HueFrame,
				Rotation = 90,
				Color = ColorSequence.new{
					ColorSequenceKeypoint.new(0, Color3.fromRGB(255,0,0)),
					ColorSequenceKeypoint.new(0.167, Color3.fromRGB(255,255,0)),
					ColorSequenceKeypoint.new(0.333, Color3.fromRGB(0,255,0)),
					ColorSequenceKeypoint.new(0.5, Color3.fromRGB(0,255,255)),
					ColorSequenceKeypoint.new(0.667, Color3.fromRGB(0,0,255)),
					ColorSequenceKeypoint.new(0.833, Color3.fromRGB(255,0,255)),
					ColorSequenceKeypoint.new(1, Color3.fromRGB(255,0,0))
				}
			})
			
			local HueCursor = Create("Frame", {
				Parent = HueFrame,
				BackgroundColor3 = Color3.new(1,1,1),
				Size = UDim2.new(1, 0, 0, 4),
				Position = UDim2.new(0, 0, ColorH, 0),
				AnchorPoint = Vector2.new(0, 0.5),
				BorderSizePixel = 0
			})
			
			local function UpdateColor()
				local newColor = Color3.fromHSV(ColorH, ColorS, ColorV)
				Preview.BackgroundColor3 = newColor
				SVImage.BackgroundColor3 = Color3.fromHSV(ColorH, 1, 1)
				callback(newColor)
			end
			
			-- Logic for SV
			local draggingSV = false
			SVImage.InputBegan:Connect(function(input)
				if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then draggingSV = true end
			end)
			SVImage.InputEnded:Connect(function(input)
				if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then draggingSV = false end
			end)
			UserInputService.InputChanged:Connect(function(input)
				if draggingSV and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
					local relX = math.clamp((input.Position.X - SVImage.AbsolutePosition.X) / SVImage.AbsoluteSize.X, 0, 1)
					local relY = math.clamp((input.Position.Y - SVImage.AbsolutePosition.Y) / SVImage.AbsoluteSize.Y, 0, 1)
					
					ColorS = relX
					ColorV = 1 - relY
					
					SVCursor.Position = UDim2.new(relX, 0, relY, 0)
					UpdateColor()
				end
			end)
			
			-- Logic for Hue
			local draggingHue = false
			HueFrame.InputBegan:Connect(function(input)
				if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then draggingHue = true end
			end)
			HueFrame.InputEnded:Connect(function(input)
				if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then draggingHue = false end
			end)
			UserInputService.InputChanged:Connect(function(input)
				if draggingHue and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
					local relY = math.clamp((input.Position.Y - HueFrame.AbsolutePosition.Y) / HueFrame.AbsoluteSize.Y, 0, 1)
					
					ColorH = 1 - relY -- Invert because gradients usually go Top-Bottom, but math varies
					-- Correction for Standard Roblox Gradient Order:
					-- 0 is Top (Red), 1 is Bottom (Red).
					ColorH = relY 
					
					HueCursor.Position = UDim2.new(0, 0, relY, 0)
					UpdateColor()
				end
			end)
			
			ToggleBtn.MouseButton1Click:Connect(function()
				isOpen = not isOpen
				TweenService:Create(PickerFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quart), {Size = UDim2.new(1, 0, 0, isOpen and 240 or 40)}):Play()
			end)
		end
		
		return Elements
	end
	
	return LibraryLogic
end

return Astral
